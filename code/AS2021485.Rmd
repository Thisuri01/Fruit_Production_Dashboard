---
title: "Fruit Production in Sri Lanka"
output_dir: docs
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme:
      version: 5
      bootswatch: darkly
---


```{r setup, include=FALSE, warning=FALSE, message=FALSE}

#### ---- pkg ----
library(flexdashboard)
library(tidyverse)
library(plotly)
library(patchwork)
library(dplyr)
library(visdat)
library(DT)
library(sp)
library(sf)
library(raster)
library(viridis)
library(scales)

### ---- cust ----
theme_set(theme_gray()) 

type_fruit <- c(
  "Limes" = "#2ecc71",    
  "Mangoes" = "#e74c3c",    
  "Oranges" = "#f39c12",    
  "Papaws" = "#1abc9c",      
  "Plantains" = "#375a7f"    
)


### ---- data ----
# install.packages("devtools")
#devtools::install_github("thiyangt/ceylon")
library(ceylon)
library(readr)
data <- read_csv("data.csv")
str(data)
```


# Overview

## Column

```{r}

# Filter 2024 data
data_2024 <- data |> filter(Year == 2024)

# Calculate KPIs
total_prod_2024 <- sum(data_2024$Production, na.rm = TRUE)
total_extent_2024 <- sum(data_2024$Extent, na.rm = TRUE)
fruit_types <- length(unique(data$Fruit))

top_fruit <- data_2024 |>
  group_by(Fruit) |>
  summarise(total_prod = sum(Production, na.rm = TRUE)) |>
  arrange(desc(total_prod)) |>
  slice(1)

top_fruit_name <- top_fruit$Fruit
top_fruit_value <- top_fruit$total_prod
top_fruit_share <- round((top_fruit_value / total_prod_2024) * 100, 1)

```

###

```{r}
valueBox(
  format(total_prod_2024, big.mark = ","),
  caption = "Total Fruit Production (000 Nuts) – 2024",
  icon = "fa-apple-alt",
  color = "#2980b9"
)
```

###

```{r}
valueBox(
  format(total_extent_2024, big.mark = ","),
  caption = "Total Area  Cultivation (hectares) – 2024",
  icon = "fa-seedling",
  color = "#f39c12"
)
```


###

```{r}
valueBox(
  top_fruit_name,top_fruit_share,
  caption = "Top Producing Fruit - 2024",
  icon = "fa-crown",
  color = "#e74c3c"
)

```



## Column

### Annual Fruit Production  

```{r, fig.height=8}
p1 <- data |>
  group_by(Year) |>
  summarise(Total_Production = sum(Production, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = Year, y = Total_Production)) +
  geom_line(color = "#2980b9") +
  geom_point() +
  scale_y_continuous(labels = comma) + 
  scale_x_continuous(breaks = seq(min(data$Year), max(data$Year), 2)) + 
  labs(
    x = "Year",
    y = "Production (000 Nuts)") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title = element_text(size = 10)
  ) 
  
ggplotly(p1)
```

### Annual Fruit Cultivation Area 

```{r, fig.height=8}
p2 <- data |>
  group_by(Year) |>
  summarise(Total_Extent = sum(Extent, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = Year, y = Total_Extent)) +
  geom_line(color = "#f39c12") +
  geom_point() +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(min(data$Year), max(data$Year), 2)) +
  labs(
    x = "Year",
    y = "Area of Cultivation (Hectares)") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title = element_text(size = 10)
  ) 
  

ggplotly(p2)
```

### Proportion of Fruits Produced in 2024

```{r}

bar_data <- data |>
  filter(Year == 2024) |>
  group_by(Fruit) |>
  summarise(Total_Production = sum(Production, na.rm = TRUE), .groups = "drop") |>
  mutate(Proportion = Total_Production / sum(Total_Production)) |>
  arrange(desc(Proportion)) |>
  mutate(Fruit = factor(Fruit, levels = Fruit))  

ggplot(bar_data, aes(x = Fruit, y = Proportion, fill = Fruit)) +
  geom_col() +
  geom_text(aes(label = scales::percent(Proportion, accuracy = 1)),
            vjust = -0.5, size = 4) +  
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.1))  # add 10% space above bars
  ) +
  scale_fill_manual(values = type_fruit) +  
  labs(
    x = "Fruit",
    y = "Proportion (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text = element_text(size = 10, face = "bold"),)

```



# Distribution by Fruit Type

### Annual Production by Fruit

```{r}
plot_fruit_trend <- function(data, variable, y_label) {
  
  data |>
    group_by(Year, Fruit) |>
    summarise(Total_Value = sum(.data[[variable]], na.rm = TRUE), .groups = "drop") |>
    ggplot(aes(x = Year, y = Total_Value, color = Fruit)) +
    geom_line() +
    geom_point() +
    scale_y_continuous(labels = comma) + 
    scale_colour_manual(values = type_fruit) +
    scale_x_continuous(breaks = seq(min(data$Year, na.rm = TRUE), 
                                    max(data$Year, na.rm = TRUE), 1)) + 
    labs(
      x = "Year",
      y = y_label,
      color = "Fruit"
    ) +
    theme(
      legend.position = "bottom",
      legend.title = element_text(face = "bold"),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
    ) 
}

p3 <- plot_fruit_trend(data, "Production", "Total Production(000 Nuts)")
ggplotly(p3)
```

### Annual Area of Cultivation by Fruit

```{r}

p4 <- plot_fruit_trend(data, "Extent", "Total Area of Cultivation (Hectares)")
ggplotly(p4)

```



# District Comparison of Production

#### *Fruit production in 2024*

## Distribution of Production {.tabset .tabset-fade} 

```{r, warning=FALSE}

data(sf_sl_0)
data(district)

data_clean <- data |>
  mutate(
    District = toupper(District),
    District = recode(District,
                      "HANBANTOTA" = "HAMBANTOTA",
                      "KALUTHARA"  = "KALUTARA",
                      "MULLATIVU"  = "MULLAITIVU")
  )

plot_fruit_production <- function(fruit) {
  data_fruit <- data_clean |>
    filter(Year == 2024, Fruit == fruit)
  
  sf_fruit <- district %>%
    left_join(data_fruit, by = c("DISTRICT" = "District"))
  
  
  ggplot(sf_fruit) +
    geom_sf(aes(fill = Production)) +
    scale_fill_viridis("Production") 
}

```


### Distribution of Oranges

```{r, warning=FALSE}

m1 <- plot_fruit_production("Oranges")
ggplotly(m1)

```

### Distribution of Limes

```{r, warning=FALSE}

m2 <- plot_fruit_production("Limes")
m2

```


### Distribution of Mangoes

```{r, warning=FALSE}

m3 <- plot_fruit_production("Mangoes")
m3

```

### Distribution of Papaws

```{r, warning=FALSE}

m4 <- plot_fruit_production("Papaws")
m4

```


### Distribution of Plantains

```{r, warning=FALSE}

m5 <- plot_fruit_production("Plantains")
m5

```



# District Comparison of Extent

#### *Fruit production in 2024*

## Distribution of Extent {.tabset .tabset-fade} 

```{r, warning=FALSE}

plot_fruit_extent <- function(fruit) {
  data_fruit <- data_clean |>
    filter(Year == 2024, Fruit == fruit)
  
  sf_fruit <- district %>%
    left_join(data_fruit, by = c("DISTRICT" = "District"))
  
  
  ggplot(sf_fruit) +
    geom_sf(aes(fill = Extent)) +
    scale_fill_viridis("fruit") 
}


```


### Distribution of Oranges

```{r, warning=FALSE}

m6 <- plot_fruit_extent("Oranges")
m6

```

### Distribution of Limes

```{r, warning=FALSE}

m7 <- plot_fruit_extent("Limes")
m7

```


### Distribution of Mangoes

```{r, warning=FALSE}

m8 <- plot_fruit_extent("Mangoes")
m8

```

### Distribution of Papaws

```{r, warning=FALSE}

m9 <- plot_fruit_extent("Papaws")
m9

```


### Distribution of Plantains

```{r, warning=FALSE}

m10 <- plot_fruit_extent("Plantains")
m10

```


# Productivity

```{r}
data <- data |>
  mutate(Productivity = round((Production / Extent) * 1000, 2))


```

## Column {.tabset .tabset-fade}

###  Distribution of Productivity with respect to Fruit

```{r}

p5 <- data |>
  group_by(Year, Fruit) |>
  summarise(Productivity = mean(Productivity, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = Year, y = Fruit, fill = Productivity)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "plasma") +
  scale_x_continuous(
    breaks = seq(min(data$Year, na.rm = TRUE), max(data$Year, na.rm = TRUE), 1)
  ) +
  labs(
    x = "Year",
    y = "Fruit",
    fill = "Productivity"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 10),
    plot.title = element_text(face = "bold", size = 10, hjust = 0.5),
  )

ggplotly(p5)

```

###  Distribution of Productivity with respect to District

```{r}
p6 <- data |>
  group_by(Year, District) |>
  summarise(Productivity = round(mean(Productivity, na.rm = TRUE), 2), .groups = "drop") |>
  mutate(Productivity = (Productivity - min(Productivity, na.rm = TRUE)) /
                         (max(Productivity, na.rm = TRUE) - min(Productivity, na.rm = TRUE))) |>
  ggplot(aes(x = Year, y = District, fill = Productivity)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "plasma") +
  scale_x_continuous(
    breaks = seq(min(data$Year, na.rm = TRUE), max(data$Year, na.rm = TRUE), 1)
  ) +
  labs(
    x = "Year",
    y = "District",
    title = "Distribution of Productivity with respect to District (Min-Max Scaled)",
    fill = "Min-max Productivity"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.text = element_text(size = 10),
    plot.title = element_text(face = "bold", size = 10, hjust = 0.5)
  )

ggplotly(p6)

```

### Productivity vs Production

```{r}

scatter_data <- data |>
  group_by(Year, Fruit) |>  
  summarise(
    Total_Production = sum(Production, na.rm = TRUE),
    Total_Extent = sum(Extent, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(Productivity = Total_Production / Total_Extent)

# Production vs Productivity
p7 <- ggplot(scatter_data, aes(x = Total_Production, y = Productivity, color = Fruit,text = paste("Fruit:", Fruit, "<br>Production:", Total_Production,"<br>Productivity:", round(Productivity,2)))) +
  geom_point(size = 4, alpha = 0.7) +
  labs(
    x = "Production (000 Nuts)",
    y = "Productivity",
    title = "Production vs Productivity",
    color = "Fruit"
  ) +
  scale_colour_manual(values = type_fruit) 

ggplotly(p7)

```

### Production vs Extent

```{r}

p8 <- ggplot(scatter_data, aes(x = Total_Extent, y = Productivity, color = Fruit, text = paste("Fruit:", Fruit, "<br>Extent:", Total_Extent, "<br>Productivity:", round(Productivity,2)))) +
  geom_point(size = 4, alpha = 0.7) +
  labs(
    x = "Area of Cultivation (hectare)",
    y = "Productivity",
    title = "Area of Cultivation vs Productivity",
    color = "Fruit"
  ) +
  scale_colour_manual(values = type_fruit) +
  scale_size_continuous(range = c(3, 10)) 

ggplotly(p8)
```

 
 
# data

```{r}
datatable( data,
           extensions = "Buttons",
           options = list(
             dom = 'Bfrtip',
             buttons = c('copy',
                         'print',
                         'csv')
           ))
```



# About

This dashboard examines the spatio-temporal patterns of production and cultivation for Mangoes, Limes, Papaws, Plantains, and Oranges in Sri Lanka from 2001 to 2024. 

**Data**

All data were sourced from the Department of Census and Statistics, Sri Lanka (https:/www.statistics.gov.lk/HIES/HIES2006_07Website/).

District-level maps were generated using the ceylon package in R (https://github.com/thiyangt/ceylon). The dashboard was developed in R Markdown to ensure full reproducibility of the outputs.

**Data description**

* Production - Fruit production (000 Nuts)

* Extent - Area of cultivation in hectare

**Remarks**

Productivity = (Production / Extent) * 1000

Measuresd in nuts per hectare
